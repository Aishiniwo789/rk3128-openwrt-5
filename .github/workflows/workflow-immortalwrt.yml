name: Build OpenWrt for RK3128 Printer Server

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git libncurses5-dev libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools python3-dev rsync subversion swig time unzip wget python3-pyelftools zlib1g-dev lib32z1-dev
    
    - name: Clone OpenWrt 19.07.10
      run: |
        git clone --depth=1 --branch v19.07.10 https://github.com/openwrt/openwrt.git openwrt
    
    - name: Copy Configuration File
      run: cp .config openwrt/
    
    - name: Setup Feeds
      run: |
        cd openwrt
        echo "src-git packages https://git.openwrt.org/feed/packages.git;openwrt-19.07" > feeds.conf.default
        echo "src-git luci https://git.openwrt.org/project/luci.git;openwrt-19.07" >> feeds.conf.default
        echo "src-git routing https://git.openwrt.org/feed/routing.git;openwrt-19.07" >> feeds.conf.default
        echo "src-git telephony https://git.openwrt.org/feed/telephony.git;openwrt-19.07" >> feeds.conf.default
    
    - name: Update and Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Apply Configuration
      run: |
        cd openwrt
        make defconfig
        # 验证配置，确保没有冲突
        echo "检查配置..."
        if grep -q "CONFIG_PACKAGE_dnsmasq=y" .config && grep -q "CONFIG_PACKAGE_dnsmasq-full=y" .config; then
          echo "错误: 检测到 dnsmasq 和 dnsmasq-full 冲突"
          echo "修正配置..."
          sed -i 's/CONFIG_PACKAGE_dnsmasq-full=y/CONFIG_PACKAGE_dnsmasq-full=n/' .config
        fi
    
    - name: Download Sources
      run: |
        cd openwrt
        make -j$(nproc) download
    
    - name: Build Firmware
      run: |
        cd openwrt
        make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log
    
    - name: Check Output Files
      run: |
        cd openwrt
        echo "查找输出文件..."
        find bin/ -type f -name "*.img*" -o -name "*.bin*" 2>/dev/null | head -20
        if [ -d "bin/targets/rockchip/armv8" ]; then
          echo "输出目录内容:"
          ls -la bin/targets/rockchip/armv8/
          echo "固件文件:"
          find bin/targets/rockchip/armv8/ -type f -name "*.img*" -o -name "*.bin*" | sort
        fi
    
    - name: Upload Firmware Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-printer-firmware
        path: openwrt/bin/targets/rockchip/armv8/
        retention-days: 30
    
    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          openwrt/build.log
          openwrt/.config
        retention-days: 7
