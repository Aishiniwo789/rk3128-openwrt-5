name: Build OpenWrt RK3128 - Simple

on: [workflow_dispatch, push]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache file g++ gawk gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip wget zlib1g-dev
    
    - name: Clone OpenWrt 21.02.7
      run: |
        git clone --depth=1 https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout v21.02.7
    
    - name: Copy Config
      run: cp .config openwrt/
    
    - name: Setup Feeds
      run: |
        cd openwrt
        echo "src-git packages https://git.openwrt.org/feed/packages.git^3e4d2a7c5f1f3b7c8a9b0c1d2e3f4a5b6c7d8e9f" > feeds.conf.default
        echo "src-git luci https://git.openwrt.org/project/luci.git^3e4d2a7c5f1f3b7c8a9b0c1d2e3f4a5b6c7d8e9f" >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Configure
      run: |
        cd openwrt
        make defconfig
    
    - name: Download
      run: |
        cd openwrt
        make download -j$(nproc)
    
    - name: Build
      run: |
        cd openwrt
        make -j$(($(nproc)+1)) || make -j1 V=s
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-images
        path: openwrt/bin/targets/rockchip/rk3128/*.img.gz
