name: Build OpenWrt for RK3128 Printer Server

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

env:
  TARGET: "rockchip"
  SUBTARGET: "armv8"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python2.7 python2.7-dev python3 python3-dev
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git libncurses5-dev libncursesw5-dev libssl-dev python3-distutils python3-setuptools rsync subversion swig time unzip wget python3-pyelftools zlib1g-dev lib32z1-dev
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python
    
    - name: Clone ImmortalWrt 21.02
      run: |
        echo "克隆 ImmortalWrt openwrt-21.02 分支..."
        git clone --depth=1 --branch openwrt-21.02 https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt
        echo "源码克隆完成"
    
    - name: Copy Configuration and Verify
      run: |
        echo "复制配置文件..."
        cp .config openwrt/
        cd openwrt
        echo "验证配置文件..."
        echo "当前目录: $(pwd)"
        echo "配置文件内容摘要:"
        echo "========================"
        grep -E "CONFIG_TARGET|CONFIG_DEVICE" .config
        echo "========================"
        
        # 确保设备配置正确
        if ! grep -q "CONFIG_TARGET_rockchip_armv8_DEVICE_tlink-r1=y" .config; then
          echo "错误: 未正确配置 tlink-r1 设备"
          echo "当前设备配置:"
          grep "CONFIG_TARGET.*DEVICE" .config
          exit 1
        fi
    
    - name: Setup Feeds
      run: |
        cd openwrt
        echo "配置软件源..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Apply Configuration
      run: |
        cd openwrt
        echo "应用配置..."
        make defconfig
        echo "配置应用完成，检查最终配置:"
        echo "目标设备:"
        grep "CONFIG_TARGET.*DEVICE" .config
        echo "目标架构:"
        grep "CONFIG_TARGET.*armv8" .config
    
    - name: Download Sources
      run: |
        cd openwrt
        echo "下载源码包..."
        make -j$(nproc) download
    
    - name: Build Firmware
      run: |
        cd openwrt
        echo "开始编译固件..."
        echo "当前配置的设备: $(grep 'CONFIG_TARGET.*DEVICE' .config)"
        make FORCE=1 -j$(($(nproc)+1)) V=s 2>&1 | tee build.log
        echo "编译完成，退出码: $?"
    
    - name: Find and List Firmware Files
      run: |
        cd openwrt
        echo "详细查找固件文件..."
        echo "当前目录: $(pwd)"
        
        # 查找所有可能的输出目录
        echo "检查bin目录结构:"
        find bin/ -type d 2>/dev/null | grep -v ".git" | sort
        
        # 查找所有固件文件
        echo "查找所有固件文件:"
        find . -type f \( -name "*.img*" -o -name "*.bin*" -o -name "*.gz" \) 2>/dev/null | grep -v ".git" | sort
        
        # 特别查找tlink相关文件
        echo "查找tlink相关文件:"
        find . -type f -name "*tlink*" 2>/dev/null
        
        # 查找RK3128相关文件
        echo "查找RK3128相关文件:"
        find . -type f -name "*rk3128*" 2>/dev/null
        
        # 检查标准输出目录
        if [ -d "bin/targets/rockchip/armv8" ]; then
          echo "标准输出目录内容:"
          ls -la bin/targets/rockchip/armv8/
          echo "固件文件列表:"
          find bin/targets/rockchip/armv8/ -type f \( -name "*.img*" -o -name "*.bin*" -o -name "*.gz" \) 2>/dev/null
        fi
    
    - name: Upload Firmware Files
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-firmware
        path: |
          openwrt/bin/targets/rockchip/armv8/*tlink*
          openwrt/bin/targets/rockchip/armv8/*rk3128*
          openwrt/bin/targets/rockchip/armv8/*.img.gz
          openwrt/bin/targets/rockchip/armv8/*.bin
        retention-days: 30
    
    - name: Upload All Output as Backup
      uses: actions/upload-artifact@v4
      with:
        name: all-output-backup
        path: openwrt/bin/targets/rockchip/armv8/
        retention-days: 30
    
    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: openwrt/build.log
        retention-days: 7
