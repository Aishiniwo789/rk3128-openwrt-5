name: Build OpenWrt for RK3128 Printer Server

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git libncurses5-dev libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools python3-dev rsync subversion swig time unzip wget python3-pyelftools zlib1g-dev lib32z1-dev
    
    - name: Clone OpenWrt 19.07.10 (Recommended for RK3128)
      run: |
        git clone --depth=1 --branch v19.07.10 https://github.com/openwrt/openwrt.git openwrt-source
    
    - name: Copy Configuration File
      run: cp .config openwrt-source/
    
    - name: Setup Feeds for 19.07
      run: |
        cd openwrt-source
        echo "src-git packages https://git.openwrt.org/feed/packages.git;openwrt-19.07" > feeds.conf.default
        echo "src-git luci https://git.openwrt.org/project/luci.git;openwrt-19.07" >> feeds.conf.default
        echo "src-git routing https://git.openwrt.org/feed/routing.git;openwrt-19.07" >> feeds.conf.default
        echo "src-git telephony https://git.openwrt.org/feed/telephony.git;openwrt-19.07" >> feeds.conf.default
    
    - name: Update and Install Feeds
      run: |
        cd openwrt-source
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Apply Configuration
      run: |
        cd openwrt-source
        make defconfig
    
    - name: Apply RK3128 Patch (Fix VDSO and Architecture)
      run: |
        cd openwrt-source
        cat > rk3128-fix.patch << 'EOF'
--- a/target/linux/rockchip/Makefile
+++ b/target/linux/rockchip/Makefile
@@ -16,11 +16,11 @@ include $(INCLUDE_DIR)/target.mk
 DEFAULT_PACKAGES += \
 	badblocks blkid fdisk lsblk mkf2fs e2fsprogs kmod-usb-storage \
 	kmod-scsi-core kmod-scsi-generic kmod-fs-vfat kmod-fs-exfat \
-	kmod-fs-ext4 kmod-fs-ntfs kmod-fs-hfs kmod-fs-hfsplus
+	kmod-fs-ext4
 
 KERNELNAME := zImage dtbs
 
-ARCH:=arm64
+ARCH:=arm
 BOARD:=rockchip
 BOARDNAME:=Rockchip
 FEATURES:=ext4 audio usb usbgadget display gpio fpu pci rtc
--- a/target/linux/rockchip/armv8/config-5.4
+++ b/target/linux/rockchip/armv8/config-5.4
@@ -1,5 +1,8 @@
 # CONFIG_64BIT is not set
+CONFIG_32BIT=y
 CONFIG_ARCH_MULTI_V6_V7=y
+CONFIG_ARCH_ROCKCHIP=y
+CONFIG_ARM=y
 CONFIG_ARM_APPENDED_DTB=y
 CONFIG_ARM_ATAG_DTB_COMPAT=y
 CONFIG_ARM_CPU_SUSPEND=y
@@ -37,6 +40,7 @@ CONFIG_CPU_FREQ_GOV_USERSPACE=y
 CONFIG_CPU_FREQ_STAT=y
 CONFIG_CPU_IDLE=y
 CONFIG_CPU_PABRT_V7=y
+CONFIG_CPU_THUMB_CAPABLE=y
 CONFIG_CPU_TLB_V7=y
 CONFIG_CPU_V7=y
 CONFIG_CRYPTO_AEAD=y
@@ -57,7 +61,6 @@ CONFIG_DMA_CMA=y
 CONFIG_DRM=y
 CONFIG_DRM_BRIDGE=y
 CONFIG_DRM_FBDEV_EMULATION=y
-CONFIG_DRM_FBDEV_OVERALLOC=100
 CONFIG_DRM_GEM_CMA_HELPER=y
 CONFIG_DRM_KMS_CMA_HELPER=y
 CONFIG_DRM_KMS_FB_HELPER=y
@@ -67,7 +70,6 @@ CONFIG_DRM_PANEL_SIMPLE=y
 CONFIG_DRM_ROCKCHIP=y
 CONFIG_DRM_ROCKCHIP_ANALOGIX_DP=y
 CONFIG_DRM_ROCKCHIP_DW_HDMI=y
-CONFIG_DRM_ROCKCHIP_DW_MIPI_DSI=y
 CONFIG_DRM_ROCKCHIP_INNO_HDMI=y
 CONFIG_DRM_ROCKCHIP_RGB=y
 CONFIG_DRM_ROCKCHIP_RK3066_HDMI=y
@@ -84,7 +86,6 @@ CONFIG_FB_CMDLINE=y
 CONFIG_FIXED_PHY=y
 CONFIG_FIX_EARLYCON_MEM=y
 CONFIG_FRAME_POINTER=y
-CONFIG_FW_LOADER_USER_HELPER=y
 CONFIG_GENERIC_ALLOCATOR=y
 CONFIG_GENERIC_BUG=y
 CONFIG_GENERIC_CLOCKEVENTS=y
@@ -96,7 +97,6 @@ CONFIG_HAVE_ARM_ARCH_TIMER=y
 CONFIG_HAVE_ARM_SCU=y
 CONFIG_HAVE_ARM_TWD=y
 CONFIG_HZ=100
-CONFIG_HZ_100=y
 CONFIG_I2C=y
 CONFIG_I2C_BOARDINFO=y
 CONFIG_I2C_CHARDEV=y
@@ -107,7 +107,6 @@ CONFIG_I2C_RK3X=y
 CONFIG_INPUT=y
 CONFIG_INPUT_EVDEV=y
 CONFIG_INPUT_KEYBOARD=y
-CONFIG_INPUT_MOUSE=y
 CONFIG_INPUT_TOUCHSCREEN=y
 CONFIG_IOMMU_HELPER=y
 CONFIG_IRQCHIP=y
@@ -136,6 +135,7 @@ CONFIG_MEDIA_SUPPORT=y
 CONFIG_MEDIA_USB_SUPPORT=y
 CONFIG_MEMORY=y
 CONFIG_MFD_CORE=y
+CONFIG_MFD_SYSCON=y
 CONFIG_MIGHT_HAVE_CACHE_L2X0=y
 CONFIG_MMC=y
 CONFIG_MMC_BLOCK=y
@@ -155,7 +155,6 @@ CONFIG_NLS=y
 CONFIG_NLS_UTF8=y
 CONFIG_NO_HZ=y
 CONFIG_NVMEM=y
-CONFIG_OF=y
 CONFIG_OF_ADDRESS=y
 CONFIG_OF_EARLY_FLATTREE=y
 CONFIG_OF_FLATTREE=y
@@ -209,8 +208,6 @@ CONFIG_REGULATOR_FIXED_VOLTAGE=y
 CONFIG_REGULATOR_GPIO=y
 CONFIG_REGULATOR_PWM=y
 CONFIG_REGULATOR_RK808=y
-CONFIG_RESET_CONTROLLER=y
-CONFIG_ROCKCHIP_CDN_DP=y
 CONFIG_ROCKCHIP_CLK_BOOST=y
 CONFIG_ROCKCHIP_DDRCLK=y
 CONFIG_ROCKCHIP_DW_HDMI=y
@@ -248,12 +245,10 @@ CONFIG_SERIAL_8250_RUNTIME_UARTS=5
 CONFIG_SERIAL_OF_PLATFORM=y
 CONFIG_SERIO=y
 CONFIG_SERIO_LIBPS2=y
-CONFIG_SMSC_PHY=y
 CONFIG_SOC_BUS=y
 CONFIG_SPI=y
 CONFIG_SPI_BITBANG=y
 CONFIG_SPI_MASTER=y
-CONFIG_SPI_ROCKCHIP=y
 CONFIG_SRCU=y
 CONFIG_STMMAC_ETH=y
 CONFIG_STMMAC_PLATFORM=y
@@ -271,9 +266,7 @@ CONFIG_SWCONFIG=y
 CONFIG_SWCONFIG_B53=y
 CONFIG_SWCONFIG_B53_MMAP_API=y
 CONFIG_SWCONFIG_B53_PHY_FIXUP=y
-CONFIG_SWCONFIG_B53_SRAB_DRIVER=y
 CONFIG_SWPHY=y
-CONFIG_SYSCON=y
 CONFIG_SYS_SUPPORTS_APM_EMULATION=y
 CONFIG_THERMAL=y
 CONFIG_THERMAL_DEFAULT_GOV_STEP_WISE=y
@@ -284,7 +277,6 @@ CONFIG_TICK_CPU_ACCOUNTING=y
 CONFIG_TIMER_OF=y
 CONFIG_TIMER_PROBE=y
 CONFIG_TREE_SRCU=y
-CONFIG_UIO=y
 CONFIG_USB=y
 CONFIG_USB_COMMON=y
 CONFIG_USB_DWC2=y
@@ -304,12 +296,10 @@ CONFIG_USB_SUPPORT=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_PLATFORM=y
 CONFIG_USE_OF=y
-CONFIG_V4L_PLATFORM_DRIVERS=y
 CONFIG_V4L2_FWNODE=y
 CONFIG_VFP=y
 CONFIG_VFPv3=y
 CONFIG_VIDEOMODE_HELPERS=y
 CONFIG_VM_EVENT_COUNTERS=y
 CONFIG_WATCHDOG_CORE=y
-CONFIG_XZ_DEC=y
 EOF
        patch -p1 < rk3128-fix.patch || true
    
    - name: Download Sources
      run: |
        cd openwrt-source
        make -j$(nproc) download
    
    - name: Build Firmware
      run: |
        cd openwrt-source
        make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log || make -j1 V=s 2>&1 | tee build-detail.log
    
    - name: Check Output Files
      run: |
        cd openwrt-source
        echo "搜索固件文件..."
        find bin/ -name "*.img*" -o -name "*.bin*" 2>/dev/null | head -20 || true
        if [ -d "bin/targets/rockchip/armv8" ]; then
          echo "找到输出目录: bin/targets/rockchip/armv8"
          ls -la bin/targets/rockchip/armv8/
        fi
    
    - name: Upload Firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-firmware-19.07
        path: openwrt-source/bin/targets/rockchip/armv8/
        retention-days: 30
    
    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-19.07
        path: openwrt-source/build*.log
        retention-days: 7
