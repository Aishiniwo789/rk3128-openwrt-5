name: Build OpenWrt for RK3128 Printer Server

on:
  workflow_dispatch:
    inputs:
      version:
        description: '使用 ImmortalWrt 分支'
        required: false
        default: 'openwrt-21.02'
  push:
    branches: [ main, master ]

env:
  TARGET: "rockchip"
  SUBTARGET: "rk3128"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Install Build Dependencies (with Python 2.7)
      run: |
        sudo apt-get update
        # 安装 Python 2.7 和 Python 3
        sudo apt-get install -y python2.7 python2.7-dev python3 python3-dev
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git libncurses5-dev libncursesw5-dev libssl-dev python3-distutils python3-setuptools rsync subversion swig time unzip wget python3-pyelftools zlib1g-dev lib32z1-dev
        # 创建 python2 符号链接
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python
    
    - name: Clone ImmortalWrt 21.02
      run: |
        echo "克隆 ImmortalWrt openwrt-21.02 分支..."
        git clone --depth=1 --branch openwrt-21.02 https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt
        echo "源码克隆完成，当前目录: $(pwd)"
    
    - name: Copy Configuration
      run: |
        echo "复制配置文件..."
        cp .config openwrt/
        cd openwrt
        echo "验证配置文件..."
        if [ ! -f ".config" ]; then
          echo "错误: .config 文件不存在"
          exit 1
        fi
        echo "检查关键配置:"
        grep -E "CONFIG_TARGET|CONFIG_PACKAGE.*(cups|p910nd|dnsmasq)" .config | head -10
    
    - name: Setup Feeds
      run: |
        cd openwrt
        echo "配置软件源..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Apply Configuration
      run: |
        cd openwrt
        echo "应用配置..."
        make defconfig
        echo "检查包冲突..."
        # 确保 dnsmasq-full 被禁用
        if grep -q "CONFIG_PACKAGE_dnsmasq-full=y" .config; then
          echo "修复: 禁用 dnsmasq-full 以避免冲突"
          sed -i 's/CONFIG_PACKAGE_dnsmasq-full=y/CONFIG_PACKAGE_dnsmasq-full=n/' .config
        fi
        echo "最终配置摘要:"
        grep -E "CONFIG_TARGET|CONFIG_PACKAGE.*(cups|p910nd|usb-printer)" .config
    
    - name: Download Sources
      run: |
        cd openwrt
        echo "下载源码包..."
        make -j$(nproc) download
        echo "下载完成"
    
    - name: Build Firmware
      run: |
        cd openwrt
        echo "开始编译固件..."
        # 使用 FORCE=1 跳过严格检查
        make FORCE=1 -j$(($(nproc)+1)) V=s 2>&1 | tee build.log || make FORCE=1 -j1 V=s 2>&1 | tee build-detail.log
        echo "编译完成，退出码: $?"
    
    - name: Check Output Files
      run: |
        cd openwrt
        echo "查找所有可能的输出文件..."
        # 搜索所有固件文件
        find . -type f \( -name "*.img*" -o -name "*.bin*" -o -name "*.gz" \) 2>/dev/null | grep -v ".git" | head -30
        
        echo "检查目标目录结构..."
        if [ -d "bin/targets/rockchip" ]; then
          echo "Rockchip 目标目录存在:"
          ls -la bin/targets/rockchip/
          find bin/targets/rockchip/ -type d -name "*rk3128*" -o -name "*arm*" 2>/dev/null | while read dir; do
            echo "检查目录: $dir"
            ls -la "$dir"
          done
        fi
        
        # 特别检查 RK3128 相关目录
        echo "搜索 RK3128 相关文件..."
        find bin/ -type f -name "*rk3128*" -o -name "*tlink*" 2>/dev/null | head -20
    
    - name: Upload All Output Files
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-output
        path: openwrt/bin/
        retention-days: 30
    
    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          openwrt/build.log
          openwrt/build-detail.log
        retention-days: 7
