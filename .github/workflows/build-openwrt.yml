name: Build OpenWrt for RK3128 Printer Server

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python2.7 python2.7-dev python3 python3-dev
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git libncurses5-dev libncursesw5-dev libssl-dev python3-distutils python3-setuptools rsync subversion swig time unzip wget python3-pyelftools zlib1g-dev lib32z1-dev
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python
    
    - name: Clone ImmortalWrt 21.02
      run: |
        echo "克隆 ImmortalWrt openwrt-21.02 分支..."
        git clone --depth=1 --branch openwrt-21.02 https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt
        echo "源码克隆完成"
    
    - name: Verify Source Structure
      run: |
        cd openwrt
        echo "检查目标架构支持..."
        if [ -d "target/linux/rockchip" ]; then
          echo "找到 rockchip 目标平台"
          ls -la target/linux/rockchip/
          echo "子目标列表:"
          ls -la target/linux/rockchip/ 2>/dev/null || echo "无法列出子目标"
        else
          echo "错误: 未找到 rockchip 目标平台"
          exit 1
        fi
    
    - name: Copy Configuration
      run: |
        cp .config openwrt/
        cd openwrt
        echo "验证配置文件..."
        echo "目标架构: $(grep 'CONFIG_TARGET' .config | head -5)"
        echo "设备配置: $(grep 'CONFIG_TARGET.*DEVICE' .config)"
    
    - name: Setup Feeds
      run: |
        cd openwrt
        echo "配置软件源..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Apply Configuration and Verify Target
      run: |
        cd openwrt
        echo "应用配置..."
        make defconfig
        
        echo "验证最终配置..."
        echo "========== 目标配置 =========="
        grep "CONFIG_TARGET" .config | grep -v "^#"
        echo "========== 设备配置 =========="
        grep "DEVICE" .config
        
        # 检查是否配置了正确的目标
        if ! grep -q "CONFIG_TARGET_rockchip_rk3128=y" .config; then
          echo "错误: 未正确配置 RK3128 目标"
          exit 1
        fi
        
        if ! grep -q "CONFIG_TARGET_rockchip_rk3128_DEVICE_tlink-r1=y" .config; then
          echo "警告: 未配置 tlink-r1 设备"
          echo "当前设备配置:"
          grep "CONFIG_TARGET.*DEVICE" .config
        fi
    
    - name: Download Sources
      run: |
        cd openwrt
        echo "下载源码包..."
        make -j$(nproc) download 2>&1 | tee download.log
    
    - name: Build Firmware
      run: |
        cd openwrt
        echo "开始编译固件..."
        echo "当前工作目录: $(pwd)"
        echo "使用的配置:"
        grep "CONFIG_TARGET" .config | grep -v "^#"
        
        # 编译内核测试
        echo "测试内核编译..."
        make target/linux/{clean,prepare} V=s 2>&1 | tee kernel-prepare.log
        
        # 完整编译
        echo "开始完整编译..."
        make FORCE=1 -j$(($(nproc)+1)) V=s 2>&1 | tee build.log || make FORCE=1 -j1 V=s 2>&1 | tee build-detail.log
        
        echo "编译完成"
    
    - name: Find and Verify Firmware
      run: |
        cd openwrt
        echo "查找固件文件..."
        
        # 检查标准输出目录
        echo "检查标准输出目录..."
        if [ -d "bin/targets/rockchip/rk3128" ]; then
          echo "找到 RK3128 输出目录:"
          ls -la bin/targets/rockchip/rk3128/
          echo "固件文件:"
          find bin/targets/rockchip/rk3128/ -type f \( -name "*.img*" -o -name "*.bin*" -o -name "*.gz" \) 2>/dev/null
        fi
        
        # 搜索所有固件文件
        echo "搜索所有固件文件..."
        find bin/ -type f \( -name "*.img*" -o -name "*.bin*" -o -name "*.gz" \) 2>/dev/null | head -20
        
        # 特别搜索 tlink 相关文件
        echo "搜索 tlink 相关文件..."
        find bin/ -type f -name "*tlink*" 2>/dev/null
        
        # 搜索 RK3128 相关文件
        echo "搜索 RK3128 相关文件..."
        find bin/ -type f -name "*rk3128*" 2>/dev/null
    
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-firmware
        path: |
          openwrt/bin/targets/rockchip/rk3128/
          openwrt/bin/targets/rockchip/rk3128/*.img*
          openwrt/bin/targets/rockchip/rk3128/*.bin*
        retention-days: 30
    
    - name: Upload All Output as Backup
      uses: actions/upload-artifact@v4
      with:
        name: all-output-backup
        path: openwrt/bin/
        retention-days: 30
    
    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          openwrt/build.log
          openwrt/build-detail.log
          openwrt/download.log
          openwrt/kernel-prepare.log
        retention-days: 7
