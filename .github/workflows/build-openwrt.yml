name: Build OpenWRT for RK3128 Printer Server
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWRT版本'
        required: true
        default: '21.02'
        type: choice
        options:
          - '21.02'
          - '22.03'
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup build environment
        run: sudo apt-get update && sudo apt-get install -y build-essential ccache file g++ gawk gettext git libncurses5-dev libssl-dev python3 python3-distutils python3-setuptools rsync unzip wget
      - name: Download OpenWRT source
        run: git clone --depth=1 https://github.com/openwrt/openwrt.git openwrt-src && cd openwrt-src && git checkout openwrt-${{ github.event.inputs.version }}
      - name: Update and install feeds
        run: cd openwrt-src && ./scripts/feeds update -a && ./scripts/feeds install -a
      - name: Apply configurations
        run: cd openwrt-src && cat ../configs/rk3128.config > .config && cat ../configs/printer-server.config >> .config
      - name: Copy custom files
        run: cd openwrt-src && mkdir -p files/etc/config files/etc/init.d files/usr/lib/cups/backend && cp -r ../files/* .
      - name: Make files executable
        run: cd openwrt-src && chmod +x files/etc/init.d/cups files/usr/lib/cups/backend/usb files/etc/rc.local
      - name: Configure build
        run: cd openwrt-src && make defconfig
      - name: Download packages
        run: cd openwrt-src && make download -j4
      - name: Build OpenWRT
        run: cd openwrt-src && make -j$(($(nproc) + 1))
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-rk3128-${{ github.event.inputs.version }}
          path: openwrt-src/bin/targets/rockchip/armv8/*.img.gz
