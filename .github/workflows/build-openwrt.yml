name: Build OpenWrt for RK3128 Printer Server

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'

env:
  OPENWRT_VERSION: "21.02.7"
  TARGET: "rockchip"
  SUBTARGET: "rk3128"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git libncurses5-dev libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools python3-dev rsync subversion swig time unzip wget python3-pyelftools zlib1g-dev lib32z1-dev
    
    - name: Clone OpenWrt Source
      run: |
        git clone --depth=1 https://github.com/openwrt/openwrt.git openwrt-source
        cd openwrt-source
        git checkout ${{ env.OPENWRT_VERSION }}
    
    - name: Setup Feeds Configuration
      run: |
        cd openwrt-source
        cat > feeds.conf.default << 'EOF'
        src-git packages https://git.openwrt.org/feed/packages.git^3e4d2a7c5f1f3b7c8a9b0c1d2e3f4a5b6c7d8e9f
        src-git luci https://git.openwrt.org/project/luci.git^3e4d2a7c5f1f3b7c8a9b0c1d2e3f4a5b6c7d8e9f
        src-git routing https://git.openwrt.org/feed/routing.git^3e4d2a7c5f1f3b7c8a9b0c1d2e3f4a5b6c7d8e9f
        src-git telephony https://git.openwrt.org/feed/telephony.git^3e4d2a7c5f1f3b7c8a9b0c1d2e3f4a5b6c7d8e9f
        EOF
    
    - name: Copy Configuration File
      run: cp .config openwrt-source/
    
    - name: Update and Install Feeds
      run: |
        cd openwrt-source
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Apply Configuration
      run: |
        cd openwrt-source
        make defconfig
    
    - name: Download Sources with Retry
      run: |
        cd openwrt-source
        for i in {1..3}; do
          if make -j$(nproc) download; then
            echo "Download successful"
            break
          else
            echo "Download attempt $i failed, retrying..."
            sleep 5
          fi
        done
        make -j$(nproc) tools/install
        make -j$(nproc) toolchain/install
    
    - name: Compile Firmware with Debug
      run: |
        cd openwrt-source
        make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log || make -j1 V=s 2>&1 | tee build-detail.log
    
    - name: List Output Directory
      run: |
        cd openwrt-source/bin/targets
        find . -name "*.img*" -o -name "*.bin*" | head -20
        ls -la rockchip/rk3128/ 2>/dev/null || echo "No output directory found"
    
    - name: Upload Firmware Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.run_id }}
        path: openwrt-source/bin/targets/rockchip/rk3128/
        retention-days: 30
    
    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_id }}
        path: |
          openwrt-source/build.log
          openwrt-source/build-detail.log
          openwrt-source/.config
        retention-days: 7
    
    - name: Upload Error Logs on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs-${{ github.run_id }}
        path: |
          openwrt-source/build.log
          openwrt-source/build-detail.log
          openwrt-source/logs/
          openwrt-source/tmp/
        retention-days: 7
