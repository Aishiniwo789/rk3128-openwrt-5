name: Build OpenWrt 19.07 for RK3128

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python2.7 python2.7-dev
        sudo apt-get install -y build-essential ccache file g++ gawk gettext git libncurses5-dev libssl-dev python2.7-distutils rsync unzip wget zlib1g-dev
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python
    
    - name: Clone OpenWrt 19.07.10
      run: git clone --depth=1 --branch v19.07.10 https://github.com/openwrt/openwrt.git openwrt
    
    - name: Copy Configuration
      run: cp .config openwrt/
    
    - name: Setup Feeds
      run: |
        cd openwrt
        echo "src-git packages https://git.openwrt.org/feed/packages.git;openwrt-19.07" > feeds.conf.default
        echo "src-git luci https://git.openwrt.org/project/luci.git;openwrt-19.07" >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Configure and Build
      run: |
        cd openwrt
        make defconfig
        make -j$(nproc) download
        make FORCE=1 -j$(($(nproc)+1))
    
    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-firmware
        path: openwrt/bin/targets/rockchip/rk3128/
