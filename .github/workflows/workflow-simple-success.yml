name: Build OpenWrt RK3128 - Simple and Reliable

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: sudo apt-get update && sudo apt-get install -y build-essential ccache file g++ gawk gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip wget
    
    - name: Clone OpenWrt
      run: git clone --depth=1 https://github.com/openwrt/openwrt.git openwrt && cd openwrt && git checkout 21.02.7
    
    - name: Setup and Configure
      run: |
        cd openwrt
        echo "src-git packages https://git.openwrt.org/feed/packages.git;openwrt-21.02" > feeds.conf.default
        echo "src-git luci https://git.openwrt.org/project/luci.git;openwrt-21.02" >> feeds.conf.default
        cp ../.config .
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig
    
    - name: Download and Build
      run: |
        cd openwrt
        make -j$(nproc) download
        make -j$(($(nproc)+1))
    
    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware
        path: openwrt/bin/targets/rockchip/rk3128/
